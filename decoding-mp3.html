<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=1">
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">
<meta name="robots" content="index,follow">


<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="行云小站">
<meta name="twitter:description" content="Say hello to you!">
<meta name="twitter:image:src" content="https://w568w.github.io/images/avatar.gif">

<meta property="og:url" content="https://w568w.github.io">
<meta property="og:title" content="行云小站">
<meta property="og:description" content="Say hello to you!">
<meta property="og:site_name" content="行云小站">
<meta property="og:image" content="https://w568w.github.io/images/avatar.gif">
<meta property="og:type" content="website">
<meta name="robots" content="noodp">

<meta itemprop="name" content="行云小站">
<meta itemprop="description" content="Say hello to you!">
<meta itemprop="image" content="https://w568w.github.io/images/avatar.gif">

<link rel="canonical" href="https://w568w.github.io">

<link rel="shortcut icon" href="/favicon.png">
<link rel="apple-itouch-icon" href="/favicon.png">
<link rel="stylesheet" href="/bundle/index.css">
<script type="text/javascript">
    var timeSinceLang = {
        year: '年前',
        month: '个月前',
        day: '天前',
        hour: '小时前',
        minute: '分钟前',
        second: '秒前'
    };
    var root = '';
</script>

<link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/mdui/0.4.3/css/mdui.min.css">
<script src="//cdnjs.loli.net/ajax/libs/mdui/0.4.3/js/mdui.min.js"></script>


        <meta name="keywords" content="">
        <meta name="description" content="对于Android MP3解码为PCM的一些研究">
        <meta name="author" content="w568w">
        <title>对于Android MP3解码为PCM的一些研究</title>
    </head>
    <body class=" mdui-theme-primary-indigo mdui-theme-accent-pink">
        <article class="container">
            <script>
	var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?ce65555016ddd913f5a39a943e2df6a4";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();

</script>
<script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js">
</script>
<script src="./toast.js">
</script>
<script>


$(function() {
	var now = new Date();
	if ((now.getMonth() == 11 && now.getDate() == 13) 
		|| (now.getFullYear() == 2020 && now.getMonth() == 3 && now.getDate() == 4)) {
		document.body.style = "-webkit-filter: grayscale(100%);-moz-filter: grayscale(100%);-ms-filter: grayscale(100%);-o-filter: grayscale(100%);filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1);_filter:none";
	}
});
</script>
<header>
	
	<div class="mdui-appbar mdui-appbar-scroll-hide">
		<div class="mdui-toolbar mdui-color-theme">
			<a class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#left-drawer'}">
				<i class="mdui-icon material-icons">
					menu
				</i>
			</a>
			<a href="/" class="mdui-typo-title">
				行云小站
			</a>
			<div class="mdui-toolbar-spacer">
			</div>
			<div class="mdui-textfield mdui-textfield-expandable mdui-float-right">
			  <button class="mdui-textfield-icon mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></button>
			  <input id="search" class="mdui-textfield-input" type="text" placeholder="搜索"/>
			  <button class="mdui-textfield-close mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">close</i></button>
			</div>
			<a href="javascript:location.reload()" class="mdui-btn mdui-btn-icon">
				<i class="mdui-icon material-icons">
					refresh
				</i>
			</a>
		</div>
	</div>
</header>
<div class="mdui-drawer mdui-drawer-close" id="left-drawer">
<div class="mdui-grid-tile">
  <a href="javascript:;"><img src="https://i.loli.net/2020/03/13/ZEqhb9dWgvH7CoV.jpg"/></a>
  <div class="mdui-grid-tile-actions">
    <div class="mdui-grid-tile-text">
      <div class="mdui-grid-tile-title">行云小站</div>
	  <div class="mdui-grid-tile-subtitle">Say hello to you!</div>
    </div>
  </div>
</div>
	<div class="mdui-list " style="margin-bottom: 76px;">
	<a href="/">
		<li class="mdui-list-item mdui-ripple">
			<i class="mdui-icon material-icons mdui-list-item-icon">
			home
			</i>
			<div class="mdui-list-item-content">
				
					主页
				
			</div>
		</li>
		</a>
	<a href="/archive.html">
		<li class="mdui-list-item mdui-ripple">
			<i class="mdui-icon material-icons mdui-list-item-icon">
			archive
			</i>
			<div class="mdui-list-item-content">
				
					归档
				
			</div>
		</li>
		</a>
		<a href="/tag.html">
		<li class="mdui-list-item mdui-ripple">
			<i class="mdui-icon material-icons mdui-list-item-icon">
			apps
			</i>
			<div class="mdui-list-item-content">
				
					标签
				
			</div>
		</li>
		</a>
		<a href="/gays.html">
		<li class="mdui-list-item mdui-ripple">
		
			<i class="mdui-icon material-icons mdui-list-item-icon">
			people
			</i>
			<div class="mdui-list-item-content">
				
					好基友
				
			</div>
			
		</li>
		</a>
		<a href="/about.w568w.html">
		<li class="mdui-list-item mdui-ripple">
			<i class="mdui-icon material-icons mdui-list-item-icon">
			account_circle
			</i>
			<div class="mdui-list-item-content">
				
					关于我
				
			</div>
		</li>
		</a>
		
		<a href="/atom.xml">
		<li class="mdui-list-item mdui-ripple">
		
			<i class="mdui-icon material-icons mdui-list-item-icon">
			rss_feed
			</i>
			<div class="mdui-list-item-content">
				
					订阅
				
			</div>
		</li>
		</a>
		
		</li>
	</div>

</div>
            <article class="main article">
                <h1 class="title">对于Android MP3解码为PCM的一些研究</h1>
                <section class="info">
                    <span class="avatar" style="background-image: url(/images/avatar.gif);"></span>
                    <a class="name" href="/about.w568w.html">w568w</a>
                    
                    <span id="date" class="date" data-time="1537591560"><span class="from"></span></span>
                    
                    <span class="tags"></span>
                </section>
                <article class="content"><p><img src="data:image/gif;base64,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" data-src="images/pathum-danthanarayana-466070-unsplash.jpg" alt="Photo by Pathum Danthanarayana on Unsplash" /></p>

<h1>2020年更新！</h1>

<p>注意，经测试发现，该方法必须在每一次调用<code>queueInputBuffer</code>方法时，写入的恰好是<strong>一个或多个</strong>完整的 mp3 帧，否则该数据块的解析结果将是空的，因此<strong>这个方案根本不能用！可以不用往下看了，直接用<code>lame</code>库解决吧！</strong></p>

<h1>前因</h1>

<p>最近在写一个项目，需要对大量MP3文件进行解码，并输出PCM文件。<br />
百度了一下，发现Android上提供了一些可以直接进行解码的类，很方便。</p>

<h1>过程</h1>

<p>主要需要用到的是<a href="https://developer.android.google.cn/reference/android/media/MediaExtractor"><code>MediaExtractor</code></a>和<a href="https://developer.android.google.cn/reference/android/media/MediaCodec"><code>MediaCodec</code></a>。<br />
<img src="data:image/gif;base64,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" data-src="images/mediacodec.png" alt="Media Codec工作周期" />
<code>MediaExtractor</code>在Android Developer上的解释是</p>

<blockquote>
<p>MediaExtractor facilitates extraction of demuxed,<br />
typically encoded, media data from a data source.<br />
翻译:<br />
MediaExtractor帮助从数据源中提取解复用的，<br />
通常编码的媒体数据。</p>
</blockquote>

<p>这个类可以帮助我们获取mp3文件的信息(例如比特率、位数、轨道数等)，还可以按帧提取mp3的数据(但并不解码)。我们主要使用的是后一个功能。</p>

<p>接下来，我们需要对输入的文件进行数据抽取的预处理。<br />
思路是先用<code>MediaExtractor</code>获得媒体文件的音频轨道(mp3文件一般只有一个)，然后用<code>selectTrack</code>指定该轨道。<br />
代码如下：</p>

<pre><code>        MediaExtractor mediaExtractor = new MediaExtractor();
        MediaCodec mediaCodec = null;
        mediaExtractor.setDataSource(getContext().getResources().openRawResourceFd(R.raw.mp3).getFileDescriptor()));
        int trackCount = mediaExtractor.getTrackCount();
        for (int i = 0; i &lt; trackCount; ++i) {
            MediaFormat format = mediaExtractor.getTrackFormat(i);
            String mineType = format.getString(MediaFormat.KEY_MIME);

            if (mineType.startsWith(&quot;audio&quot;)) {
                mediaExtractor.selectTrack(i);
</code></pre>

<p>然后，创建并启动<code>MediaCodec</code>，准备开始传入编码的数据。</p>

<pre><code>                mediaCodec = MediaCodec.createDecoderByType(mineType);
                mediaCodec.configure(format, null, null, 0);
                break;
            }
        }
        mediaCodec.start();
</code></pre>

<p>接下来，定义一个<code>readData</code>，用于向指定的<code>ByteBuffer</code>中写入读取的数据：</p>

<pre><code>private int readData(MediaExtractor extractor, ByteBuffer buffer, int size) {
        int totalSize = 0;
        do {
            int sampleSize;
            if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) {
                sampleSize = extractor.readSampleData(buffer, totalSize);
            } else {
                sampleSize = extractor.readSampleData(buffer, 0);
            }
            if (sampleSize &lt; 0) {
                return totalSize;
            }
            totalSize += sampleSize;
            //Advance to the next sample.
            extractor.advance();
        } while (totalSize &lt; size);
        return totalSize;
    }
</code></pre>

<p>需要注意的是，对于<code>Android Lollipop</code>及以后的版本，<code>readSampleData</code>的第二个参数必须是<code>0</code>，数据会自动填充到末尾。</p>

<hr />

<p>接下来的，是真正的解码过程。解码过程比较麻烦，具体概括为如下几步：</p>

<ol>
<li>获取<code>MediaCodec</code>的输入/输出<code>ByteBuffer</code>数组。</li>
<li>调用<code>dequeueInputBuffer</code>方法，获取下一次输入所使用的<code>ByteBuffer</code>在数组中的索引。</li>
<li>调用<code>readData</code>向该<code>ByteBuffer</code>中读取一段mp3数据。</li>
<li>调用<code>queueInputBuffer</code>方法，将这个<code>ByteBuffer</code>加入解码队列中，进行真正的解码过程。</li>
<li>调用<code>dequeueOutputBuffer</code>方法，获取下一次解码完成的数据所使用的<code>ByteBuffer</code>在数组中的索引。</li>
<li>将这个<code>ByteBuffer</code>内的数据读出，即为一个PCM片段。</li>
<li>调用<code>releaseOutputBuffer</code>释放该<code>ByteBuffer</code>。</li>
<li>循环5~7步，直到请求不到输出，这意味着当前已经没有解码的数据了。</li>
<li>不断循环以上1~8步，拼接PCM片段，直到解码全部完成。</li>
</ol>

<p>完整的解码代码如下：</p>

<pre><code class="language-java">private boolean decode(MediaCodec codec, MediaExtractor extractor) throws IOException {
        ByteBuffer[] inputDatas = codec.getInputBuffers();
        ByteBuffer[] outputDatas = codec.getOutputBuffers();

        MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo();
        //Get the max input size.
        int size = DEFAULT_BUFFER_SIZE;
        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
            size = codec.getInputFormat().getInteger(MediaFormat.KEY_MAX_INPUT_SIZE);
        }
        for (int i = 0; i &lt; inputDatas.length - 1; ++i) {
            int inputIndex = codec.dequeueInputBuffer(-1);
            if (inputIndex &lt; 0) {
                return true;
            }
            //Input data
            ByteBuffer inputBuffer = inputDatas[inputIndex];
            inputBuffer.clear();
            //Request mp3 data chunk.
            int sampleSize = readData(extractor, inputBuffer, size);
            if (sampleSize &lt;= 0) {
                return true;
            } else {
                //Have it decoded.
                codec.queueInputBuffer(inputIndex, 0, sampleSize, 0, 0);
                decodeSize += sampleSize;
                System.out.println(&quot;decode size:&quot; + sampleSize + &quot;,total size:&quot; + decodeSize);
            }
            //Get output buffer
            int outputIndex = codec.dequeueOutputBuffer(bufferInfo, TIMEOUT);
            ByteBuffer outputBuffer;
            byte[] chunkPCM;
            while (outputIndex &gt;= 0) {
                outputBuffer = outputDatas[outputIndex];
                chunkPCM = new byte[bufferInfo.size];
                outputBuffer.get(chunkPCM);
                outputBuffer.clear();
                //Write to a byte array.
                pcmData.write(chunkPCM);

                codec.releaseOutputBuffer(outputIndex, false);
                //Get next PCM chuck.
                outputIndex = codec.dequeueOutputBuffer(bufferInfo, TIMEOUT);
            }
        }
        //Have not decoded the whole file.
        return false;
    }
</code></pre>

<p>这个方法调用起来也很简单，不断调用直到返回<code>true</code>为止。</p>

<pre><code>while (!decode(mediaCodec, mediaExtractor)) {
            //Do nothing.
            //Wait for decoding.
}
</code></pre>

<p>然后解码就完成了。</p>

<hr />

<p>完整的类源代码如下：</p>

<pre><code>/**
 * Created by w568w on 18-9-15.
 *
 * @author w568w
 */

public class MP3ToPCM {
    private int decodeSize = 0;
    private ByteArrayOutputStream pcmData;
    private static final int TIMEOUT = 10 * 1000;
    private static final int DEFAULT_BUFFER_SIZE = 4096;

    /**
     * @param fileDescriptor Input MP3 File
     * @return PCM data
     * @throws IOException when decoding failed or opening the file failed.
     */
    @WorkerThread
    public byte[] convert(FileDescriptor fileDescriptor) throws IOException {
        pcmData = new ByteArrayOutputStream();
        MediaExtractor mediaExtractor = new MediaExtractor();
        MediaCodec mediaCodec = null;
        mediaExtractor.setDataSource(fileDescriptor);
        int trackCount = mediaExtractor.getTrackCount();
        for (int i = 0; i &lt; trackCount; ++i) {
            MediaFormat format = mediaExtractor.getTrackFormat(i);
            String mineType = format.getString(MediaFormat.KEY_MIME);

            if (mineType.startsWith(&quot;audio&quot;)) {
                mediaExtractor.selectTrack(i);
                mediaCodec = MediaCodec.createDecoderByType(mineType);
                mediaCodec.configure(format, null, null, 0);
                break;
            }
        }
        if (mediaCodec == null) {
            return null;
        }
        mediaCodec.start();

        while (!decode(mediaCodec, mediaExtractor)) {
            //Do nothing.
            //Wait for decoding.
        }

        byte[] pcmByteData = pcmData.toByteArray();
        pcmData.close();
        pcmData = null;
        return pcmByteData;
    }

    private int readData(MediaExtractor extractor, ByteBuffer buffer, int size) {
        int totalSize = 0;
        do {
            int sampleSize;
            if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) {
                sampleSize = extractor.readSampleData(buffer, totalSize);
            } else {
                sampleSize = extractor.readSampleData(buffer, 0);
            }
            if (sampleSize &lt; 0) {
                return totalSize;
            }
            totalSize += sampleSize;
            //Advance to the next sample.
            extractor.advance();
        } while (totalSize &lt; size);
        return totalSize;
    }

    private boolean decode(MediaCodec codec, MediaExtractor extractor) throws IOException {
        ByteBuffer[] inputDatas = codec.getInputBuffers();
        ByteBuffer[] outputDatas = codec.getOutputBuffers();

        MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo();
        //Get the max input size
        int size = DEFAULT_BUFFER_SIZE;
        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
            size = codec.getInputFormat().getInteger(MediaFormat.KEY_MAX_INPUT_SIZE);
        }
        for (int i = 0; i &lt; inputDatas.length - 1; ++i) {
            int inputIndex = codec.dequeueInputBuffer(-1);
            if (inputIndex &lt; 0) {
                return true;
            }
            //Input data
            ByteBuffer inputBuffer = inputDatas[inputIndex];
            inputBuffer.clear();
            //Request mp3 data chunk.
            int sampleSize = readData(extractor, inputBuffer, size);
            if (sampleSize &lt;= 0) {
                return true;
            } else {
                //Get it decoded.
                codec.queueInputBuffer(inputIndex, 0, sampleSize, 0, 0);
                decodeSize += sampleSize;
                System.out.println(&quot;decode size:&quot; + sampleSize + &quot;,total size:&quot; + decodeSize);
            }
            //Get output buffer
            int outputIndex = codec.dequeueOutputBuffer(bufferInfo, TIMEOUT);
            ByteBuffer outputBuffer;
            byte[] chunkPCM;
            while (outputIndex &gt;= 0) {
                outputBuffer = outputDatas[outputIndex];
                chunkPCM = new byte[bufferInfo.size];
                outputBuffer.get(chunkPCM);
                outputBuffer.clear();
                //Write to a byte array.
                pcmData.write(chunkPCM);

                codec.releaseOutputBuffer(outputIndex, false);
                //Get next PCM chuck.
                outputIndex = codec.dequeueOutputBuffer(bufferInfo, TIMEOUT);
            }
        }
        //Have not decoded the whole file.
        return false;
    }
}

</code></pre>

<h1>问题</h1>

<p>存在的问题是，解码太慢。使用的测试代码是这样的：</p>

<pre><code>/**
 * Created by w568w on 18-9-16.
 *
 * @author w568w
 */

public class MP3ToPCMTest extends AndroidTestCase {
    private byte[] PCMdata;
    private byte[] reSamplePCM;
    private static final int reSample = 512;

    public void testConvert() throws Exception {
        CodeTimer.time(new ConvertThread());

    }

    public void testReSample() throws Exception {
        CodeTimer.time(new ReSampleThread());
    }

    private class ConvertThread implements Runnable {

        @Override
        public void run() {
            try {
                PCMdata = new MP3ToPCM()
                        .convert(getContext().getResources().openRawResourceFd(R.raw.mp3).getFileDescriptor());
                System.out.println(&quot;size:&quot; + PCMdata.length);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
    private class ReSampleThread implements Runnable {

        @Override
        public void run() {
            try {
                reSamplePCM = new byte[PCMdata.length / reSample];
                for (int i = 0; i &lt; PCMdata.length; i += reSample) {
                    reSamplePCM[i / reSample] = PCMdata[i];
                }
                System.out.println(&quot;resample size:&quot; + reSamplePCM.length);
            } catch (NullPointerException e) {
                e.printStackTrace();
            }
        }
    }

}
</code></pre>

<p><code>CodeTimer</code>是个简单的代码计时器，不再贴出代码。<br />
整个解码过程需要将近1分钟的时间，显然在实际环境中是不可直接应用的。<br />
目前的思路是换用<code>lame</code>或<code>ffmpeg</code>等解编码的原生支持库。或许了解这方面的朋友可以给我指点一二？</p>
</article>
                <section class="author">
                    <div class="avatar" style="background-image: url(/images/avatar.gif);"></div>
                    <a class="name" href="/about.w568w.html">w568w</a>
                    <div class="intro">梦想改变自己的疯子。</div>
                </section>
                <section class="recommend">
                    
                    <section class="nav prev more">
                        <div class="head">上篇文章</div>
                        <a class="link" href="/calculus-1st.html">零基础微积分入门基本教程（一）</a>
                    </section>
                    
                    
                    <section class="nav next more">
                        <div class="head">下篇文章</div>
                        <a class="link" href="/fenhuang_stat.html">从一次新闻统计概览我国新闻关注热点</a>
                    </section>
                    
                </section>
                
<style>
.ThanksForInvitingLabel {
	padding-left: 12px;
	height: 42px;
	line-height: 42px;
	display: -webkit-box;
	display: -ms-flexbox;
	display: flex;
	-webkit-box-align: center;
	-ms-flex-align: center;
	align-items: center;
	background-color: #d4237a;
	color: white;
	font-size: 14px;
	border-radius: 6px;
	overflow: hidden;
	white-space: nowrap;
}
.ThanksForInvitingLabel-icon {
	margin-right: 4px;
	font-weight: 600;
	font-synthesis: style;
}
</style>
<br/>
<div class="ThanksForInvitingLabel"><span class="ThanksForInvitingLabel-icon"><span style="display: inline-flex; align-items: center;">​<svg  fill="currentColor" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="877" width="20" height="20"><path d="M896 213.333333v281.6l-128-128-170.666667 170.666667-170.666666-170.666667-170.666667 170.666667-128-128V213.333333c0-46.933333 38.4-85.333333 85.333333-85.333333h597.333334c46.933333 0 85.333333 38.4 85.333333 85.333333z m-128 273.066667l128 128V810.666667c0 46.933333-38.4 85.333333-85.333333 85.333333H213.333333c-46.933333 0-85.333333-38.4-85.333333-85.333333V529.066667l128 128 170.666667-170.666667 170.666666 170.666667 170.666667-170.666667z" p-id="878"></path></svg></span>&nbsp;Warning!&nbsp;</span>&nbsp;LiveRe&nbsp;评论系统在部分华为设备上无法使用。如果您遇到该问题，请考虑换用其他设备登陆。</div>

<div id="lv-container" data-id="city" data-uid="MTAyMC8zOTg5Ni8xNjQyMw==">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>



            </article>
        </article>
        <footer class="footer">
    <span class="copyright">
        行云小站 © 2016 - 
        <script type="text/javascript">
            document.write(new Date().getFullYear());
        </script>
		使用<a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">CC BY-NC 4.0协议</a> | 
		 <a href="https://icp.gov.moe" target="_blank">萌えサイトの記録</a><a href="https://icp.gov.moe/?keyword=20203115" target="_blank"> #20203115</a>
    </span>
   
    <span class="publish">自豪地使用 <a href="http://www.inkpaper.io/index-zh.html" target="_blank">Ink</a> 和 <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank">又拍云</a><img src="./images/upyun.png" style="height:15px;"> </span>
</footer>

        <script src="/bundle/index.js"></script>
    </body>
</html>
